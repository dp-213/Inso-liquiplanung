-- =============================================================================
-- Turso Migration: 2026-02-10
-- Zuordnungs-Korrektur & Regeln-Transparenz
-- =============================================================================

-- 1. Schema: isLiquidityRelevant auf bank_accounts
ALTER TABLE bank_accounts ADD COLUMN isLiquidityRelevant INTEGER NOT NULL DEFAULT 0;

-- 2. ISK-Konten als liquidity-relevant markieren
UPDATE bank_accounts SET isLiquidityRelevant = 1 WHERE id IN ('ba-isk-uckerath', 'ba-isk-velbert');

-- 3. Darlehens-Entries korrigieren (8 Entries)
UPDATE ledger_entries SET
  categoryTag = 'DARLEHEN_TILGUNG',
  categoryTagSource = 'MANUAL_CORRECTION',
  categoryTagNote = 'Darlehenstilgung/Zinsen Gesellschafterdarlehen (apoBank-Gläubigerkonto)',
  estateAllocation = 'ALTMASSE',
  estateRatio = 0,
  allocationSource = 'MANUAL_CORRECTION',
  allocationNote = 'Vorinsolvenzliche Gesellschafterdarlehen (SHP) = 100% Altmasse. Q4-Umsatzregel nicht anwendbar auf Darlehen.',
  counterpartyId = 'cp-servicegesellschaft-hausarztpraxis'
WHERE id IN (
  'hvplus-okt-v2-0', 'hvplus-okt-v2-1', 'hvplus-okt-v2-2', 'hvplus-okt-v2-3',
  'hvplus-okt-v2-28', 'hvplus-okt-v2-29',
  'hvplus-nov-v2-0', 'hvplus-nov-v2-2'
);

-- 4. Classification Rules für HVPlus-Case synchronisieren (19 Rules)
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('716db40b-3786-4e69-a45c-3fa48c9d01ec', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HZV TK/KKH/HEK/hkk - Monatsabschlag', 1, 10, 'description', 'REGEX', '(TK|KKH|HEK|hkk).*(Abschlag|Zahlung|HZV)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560372, 'create-hvplus-service-date-rules', 1769257560372, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('54bb14d6-ca4a-4c79-a1c8-e55d7b30bced', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HZV AOK/DAK/Barmer/GWQ - Monatsabschlag', 1, 10, 'description', 'REGEX', '(AOK|DAK|Barmer|GWQ|BARMER).*(Abschlag|Zahlung|HZV)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560375, 'create-hvplus-service-date-rules', 1769257560375, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('269f07e9-3691-4b0b-81b5-28fc61467f5e', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HZV IKK/LKK - Monatsabschlag', 1, 10, 'description', 'REGEX', '(IKK|LKK).*(Abschlag|Zahlung|HZV)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560376, 'create-hvplus-service-date-rules', 1769257560376, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('bc33ce59-0e64-4d09-9e95-7ff173ca134d', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HZV spectrumK/Knappschaft - Monatsabschlag', 1, 10, 'description', 'REGEX', '(spectrumK|Knappschaft|KNAPPSCHAFT).*(Abschlag|Zahlung|HZV)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560377, 'create-hvplus-service-date-rules', 1769257560377, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('3dec0bc9-3697-4124-bddd-e7a3057e4241', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HZV/KV Quartals-Schlusszahlung', 1, 5, 'description', 'REGEX', '(Schlusszahlung|Quartalsabrechnung|REST\s*Q\d|Q\d.*REST)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'PREVIOUS_QUARTER', 1769257560378, 'create-hvplus-service-date-rules', 1769257560378, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('dcfb411d-b71b-4b4b-8cdc-6804bb3d51f0', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'KV Nordrhein Abrechnung', 1, 5, 'description', 'REGEX', '(KVNO|KV\s*Nordrhein|Kassenärztliche).*(Q\d|Quartal)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'PREVIOUS_QUARTER', 1769257560380, 'create-hvplus-service-date-rules', 1769257560380, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('563ccff3-eb23-4d9b-9a73-ae0d71ade462', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'HAVG/HAEVG - Vormonat-Logik', 1, 50, 'description', 'REGEX', '(HAVG|HAEVG|HAEVGID)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'VORMONAT', 1769257560381, 'create-hvplus-service-date-rules', 1769257560381, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('462f6f30-758e-498b-9f81-54d75bff4d30', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Patientenzahlung - Anweisung', 1, 30, 'description', 'REGEX', '(ANWEISUNG VOM|Überweisung Patient|Zuzahlung)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560383, 'create-hvplus-service-date-rules', 1769257560383, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('71b1907b-31bd-4956-9b85-fc268be34a93', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'PVS Privatabrechnung', 1, 30, 'description', 'REGEX', '(PVS|Privatabrechnung|Privatpatient)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560385, 'create-hvplus-service-date-rules', 1769257560385, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('3b92462c-3866-481c-bc54-5edee31550f0', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Miete/Raumkosten', 1, 40, 'description', 'REGEX', '(Miete|Kaltmiete|Warmmiete|Raumkosten|Nebenkosten)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560386, 'create-hvplus-service-date-rules', 1769257560386, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('99819523-897b-4237-82e3-f66e5024ab57', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Software/IT-Wartung', 1, 40, 'description', 'REGEX', '(Software|Wartungsvertrag|PegaMed|EDV|IT-Service|Lizenz)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560387, 'create-hvplus-service-date-rules', 1769257560387, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('1f0273b9-d8be-4e71-aaa9-213760ae4ebf', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Telefon/Kommunikation', 1, 40, 'description', 'REGEX', '(Festnetz|Telefon|Aldi\s*Talk|Mobilfunk|Internet|DSL)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560388, 'create-hvplus-service-date-rules', 1769257560388, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('869ecc46-bf53-4505-acb3-4a68203fcc5e', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Versicherungen', 1, 40, 'description', 'REGEX', '(Versicherung|Haftpflicht|Berufshaftpflicht|BG)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560390, 'create-hvplus-service-date-rules', 1769257560390, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('d13ee297-f69b-4879-837c-55ee73900852', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Personalkosten/Löhne', 1, 40, 'description', 'REGEX', '(Lohn|Gehalt|Personal|Mitarbeiter)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560391, 'create-hvplus-service-date-rules', 1769257560391, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('dbb0784c-397a-4034-a772-45e83118fbd7', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Sozialversicherung', 1, 40, 'description', 'REGEX', '(SV-Beitrag|Sozialversicherung|Krankenkasse.*Arbeitgeber|KK-Beitrag)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560393, 'create-hvplus-service-date-rules', 1769257560393, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('29fb3de1-d27c-4778-b5ec-0a1f2060a930', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Steuerberater/Buchhaltung', 1, 40, 'description', 'REGEX', '(Steuerberater|Buchhaltung|Lohnabrechnung|DATEV)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560394, 'create-hvplus-service-date-rules', 1769257560394, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('c3351168-2394-45f4-84fb-a8c2aae4b4d9', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Energie/Strom/Gas', 1, 40, 'description', 'REGEX', '(Strom|Gas|Energie|Stadtwerke|EnBW|RWE)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560395, 'create-hvplus-service-date-rules', 1769257560395, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('23ab4628-295d-4d2f-a8e4-b1bd78031538', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Abfall/Entsorgung', 1, 40, 'description', 'REGEX', '(Abfall|Entsorgung|Müll|AWB|Remondis)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560396, 'create-hvplus-service-date-rules', 1769257560396, NULL);
INSERT OR IGNORE INTO classification_rules (id, caseId, name, isActive, priority, matchField, matchType, matchValue, suggestedCategory, suggestedFlowType, suggestedLegalBucket, confidenceBonus, assignBankAccountId, assignCounterpartyId, assignLocationId, assignServiceDateRule, createdAt, createdBy, updatedAt, updatedBy) VALUES ('63c7feec-0eb2-4d4e-be9b-7886c27b4ab1', '2982ff26-081a-4811-8e1e-46b39e1ff757', 'Praxisbedarf/Material', 1, 40, 'description', 'REGEX', '(Praxisbedarf|Material|Medikamente|Labor)', NULL, NULL, NULL, 0.0, NULL, NULL, NULL, 'SAME_MONTH', 1769257560397, 'create-hvplus-service-date-rules', 1769257560397, NULL);
